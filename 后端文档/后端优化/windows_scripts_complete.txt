REM ==================== start-dev.bat ====================
REM å¯åŠ¨å¼€å‘æœåŠ¡å™¨ - åŒå‡»è¿è¡Œæ­¤æ–‡ä»¶
@echo off
chcp 65001 >nul
color 0A

echo.
echo ========================================
echo ğŸš€ å¯åŠ¨ IEclub å¼€å‘æœåŠ¡å™¨
echo ========================================
echo.

REM æ£€æŸ¥ node_modules
if not exist "node_modules" (
    color 0E
    echo âš ï¸  æœªæ‰¾åˆ° node_modules ç›®å½•
    echo.
    echo æ­£åœ¨å®‰è£…ä¾èµ–...
    call npm install
    if %ERRORLEVEL% NEQ 0 (
        color 0C
        echo âŒ ä¾èµ–å®‰è£…å¤±è´¥
        pause
        exit /b 1
    )
    echo.
)

REM æ£€æŸ¥ .env æ–‡ä»¶
if not exist ".env" (
    color 0E
    echo âš ï¸  æœªæ‰¾åˆ° .env æ–‡ä»¶
    echo.
    if exist ".env.example" (
        echo æ­£åœ¨å¤åˆ¶ .env.example åˆ° .env...
        copy .env.example .env >nul
        echo âœ… .env æ–‡ä»¶å·²åˆ›å»º
        echo.
        echo âš ï¸  è¯·ç¼–è¾‘ .env æ–‡ä»¶ï¼Œé…ç½®æ•°æ®åº“å¯†ç ï¼
        echo æŒ‰ä»»æ„é”®ç»§ç»­...
        pause >nul
    ) else (
        echo âŒ ä¹Ÿæœªæ‰¾åˆ° .env.example
        echo è¯·æ‰‹åŠ¨åˆ›å»º .env æ–‡ä»¶
        pause
        exit /b 1
    )
)

REM æ£€æŸ¥æ•°æ®åº“è¿æ¥
echo æ­£åœ¨æ£€æŸ¥æ•°æ®åº“è¿æ¥...
for /f "tokens=2 delims==" %%i in ('findstr "DB_PASSWORD" .env') do set DB_PASS=%%i
for /f "tokens=2 delims==" %%i in ('findstr "DB_NAME" .env') do set DB_NAME=%%i

set PGPASSWORD=%DB_PASS%
psql -U postgres -h localhost -d %DB_NAME% -c "SELECT 1;" >nul 2>&1

if %ERRORLEVEL% EQU 0 (
    echo âœ… æ•°æ®åº“è¿æ¥æ­£å¸¸
) else (
    color 0E
    echo âš ï¸  æ•°æ®åº“è¿æ¥å¤±è´¥
    echo.
    echo å¯èƒ½çš„åŸå› ï¼š
    echo   1. PostgreSQL æœªå¯åŠ¨
    echo   2. æ•°æ®åº“ %DB_NAME% ä¸å­˜åœ¨
    echo   3. .env ä¸­çš„å¯†ç ä¸æ­£ç¡®
    echo.
    set /p CREATE_DB="æ˜¯å¦å°è¯•åˆ›å»ºæ•°æ®åº“? (y/N): "
    if /i "%CREATE_DB%"=="y" (
        psql -U postgres -h localhost -c "CREATE DATABASE %DB_NAME%;" 2>nul
        if %ERRORLEVEL% EQU 0 (
            echo âœ… æ•°æ®åº“åˆ›å»ºæˆåŠŸ
        ) else (
            echo âŒ æ•°æ®åº“åˆ›å»ºå¤±è´¥ï¼Œè¯·æ‰‹åŠ¨åˆ›å»º
        )
    )
)

echo.
echo ========================================
echo ğŸš€ æ­£åœ¨å¯åŠ¨æœåŠ¡å™¨...
echo ========================================
echo.
echo ğŸ’¡ æç¤ºï¼š
echo   - æœåŠ¡å™¨åœ°å€: http://localhost:5000
echo   - å¥åº·æ£€æŸ¥: http://localhost:5000/health
echo   - æŒ‰ Ctrl+C åœæ­¢æœåŠ¡å™¨
echo.
echo ========================================
echo.

REM å¯åŠ¨å¼€å‘æœåŠ¡å™¨
npm run dev


REM ==================== test-api.bat ====================
REM APIæµ‹è¯•è„šæœ¬ - åŒå‡»è¿è¡Œæ­¤æ–‡ä»¶
@echo off
chcp 65001 >nul
color 0B

echo.
echo ========================================
echo ğŸ§ª IEclub API æ¥å£æµ‹è¯•
echo ========================================
echo.

REM æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦è¿è¡Œ
curl -s http://localhost:5000/health >nul 2>&1
if %ERRORLEVEL% NEQ 0 (
    color 0C
    echo âŒ æœåŠ¡å™¨æœªè¿è¡Œï¼
    echo.
    echo è¯·å…ˆè¿è¡Œ start-dev.bat å¯åŠ¨æœåŠ¡å™¨
    pause
    exit /b 1
)

echo âœ… æœåŠ¡å™¨æ­£åœ¨è¿è¡Œ
echo.

REM å®šä¹‰æµ‹è¯•é‚®ç®±
set TEST_EMAIL=test_%RANDOM%@sustech.edu.cn
set TEST_PASSWORD=password123
set TEST_USERNAME=æµ‹è¯•ç”¨æˆ·%RANDOM%

echo ========================================
echo æµ‹è¯• 1/5: å¥åº·æ£€æŸ¥
echo ========================================
curl -s http://localhost:5000/health
echo.
echo.

echo ========================================
echo æµ‹è¯• 2/5: ç”¨æˆ·æ³¨å†Œ
echo ========================================
echo é‚®ç®±: %TEST_EMAIL%
echo å¯†ç : %TEST_PASSWORD%
echo.

curl -X POST http://localhost:5000/api/v1/auth/register ^
  -H "Content-Type: application/json" ^
  -d "{\"email\":\"%TEST_EMAIL%\",\"password\":\"%TEST_PASSWORD%\",\"username\":\"%TEST_USERNAME%\",\"studentId\":\"12012345\"}" ^
  -o register_response.json

echo å“åº”å·²ä¿å­˜åˆ° register_response.json
type register_response.json
echo.
echo.

REM æå–tokenï¼ˆç®€åŒ–ç‰ˆï¼Œä½¿ç”¨PowerShellï¼‰
for /f "delims=" %%i in ('powershell -Command "(Get-Content register_response.json | ConvertFrom-Json).token"') do set TOKEN=%%i

if "%TOKEN%"=="" (
    color 0C
    echo âŒ æ³¨å†Œå¤±è´¥ï¼Œæœªè·å–åˆ°token
    echo.
    pause
    exit /b 1
)

echo âœ… æ³¨å†ŒæˆåŠŸï¼ŒToken: %TOKEN:~0,20%...
echo.

echo ========================================
echo æµ‹è¯• 3/5: ç”¨æˆ·ç™»å½•
echo ========================================

curl -X POST http://localhost:5000/api/v1/auth/login ^
  -H "Content-Type: application/json" ^
  -d "{\"email\":\"%TEST_EMAIL%\",\"password\":\"%TEST_PASSWORD%\"}"

echo.
echo.

echo ========================================
echo æµ‹è¯• 4/5: è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
echo ========================================

curl -X GET http://localhost:5000/api/v1/auth/me ^
  -H "Authorization: Bearer %TOKEN%"

echo.
echo.

echo ========================================
echo æµ‹è¯• 5/5: åˆ›å»ºå¸–å­
echo ========================================

curl -X POST http://localhost:5000/api/v1/posts ^
  -H "Content-Type: application/json" ^
  -H "Authorization: Bearer %TOKEN%" ^
  -d "{\"title\":\"æµ‹è¯•å¸–å­\",\"content\":\"è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•å†…å®¹\",\"category\":\"å­¦æœ¯\",\"tags\":[\"æµ‹è¯•\",\"API\"]}"

echo.
echo.

echo ========================================
echo âœ… æµ‹è¯•å®Œæˆï¼
echo ========================================
echo.
echo æ¸…ç†ä¸´æ—¶æ–‡ä»¶...
del register_response.json 2>nul
echo.
echo ğŸ’¡ æç¤ºï¼š
echo   - æ‰€æœ‰æ¥å£æµ‹è¯•é€šè¿‡
echo   - Token: %TOKEN:~0,30%...
echo   - å¯ä»¥ç”¨æ­¤Tokenç»§ç»­æµ‹è¯•å…¶ä»–æ¥å£
echo.

pause


REM ==================== create-gitkeep.bat ====================
REM åˆ›å»º.gitkeepå ä½æ–‡ä»¶ - åŒå‡»è¿è¡Œæ­¤æ–‡ä»¶
@echo off
chcp 65001 >nul

echo.
echo ========================================
echo ğŸ“ åˆ›å»ºç›®å½•å ä½æ–‡ä»¶
echo ========================================
echo.

REM åˆ›å»ºç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
if not exist "logs" mkdir logs
if not exist "uploads" mkdir uploads
if not exist "tests" mkdir tests

REM åˆ›å»º.gitkeepæ–‡ä»¶
type nul > logs\.gitkeep
type nul > uploads\.gitkeep
type nul > tests\.gitkeep

echo âœ… logs\.gitkeep
echo âœ… uploads\.gitkeep
echo âœ… tests\.gitkeep
echo.
echo ========================================
echo âœ… å ä½æ–‡ä»¶åˆ›å»ºå®Œæˆï¼
echo ========================================
echo.
echo ğŸ“‹ è¯´æ˜ï¼š
echo   .gitkeep æ˜¯ç©ºæ–‡ä»¶ï¼Œç”¨äºè®©Gitè¿½è¸ªç©ºç›®å½•
echo   è¿™æ ·å³ä½¿ç›®å½•æ˜¯ç©ºçš„ï¼Œä¹Ÿä¼šè¢«æäº¤åˆ°Gitä»“åº“
echo.
pause


REM ==================== setup-all.bat ====================
REM ä¸€é”®å®Œæ•´è®¾ç½® - åŒå‡»è¿è¡Œæ­¤æ–‡ä»¶
@echo off
chcp 65001 >nul
color 0A

echo.
echo ========================================
echo ğŸš€ IEclub ä¸€é”®å®Œæ•´è®¾ç½®ï¼ˆWindowsï¼‰
echo ========================================
echo.

REM ç¬¬1æ­¥ï¼šåˆ›å»ºç›®å½•ç»“æ„
echo [1/6] ğŸ“ åˆ›å»ºé¡¹ç›®ç›®å½•ç»“æ„...
if not exist "src\config" mkdir src\config
if not exist "src\middleware" mkdir src\middleware
if not exist "src\models" mkdir src\models
if not exist "src\controllers" mkdir src\controllers
if not exist "src\routes" mkdir src\routes
if not exist "src\services" mkdir src\services
if not exist "src\utils" mkdir src\utils
if not exist "src\db\migrations" mkdir src\db\migrations
if not exist "src\db\seeds" mkdir src\db\seeds
if not exist "logs" mkdir logs
if not exist "uploads" mkdir uploads
if not exist "tests" mkdir tests
echo âœ… ç›®å½•åˆ›å»ºå®Œæˆ
echo.

REM ç¬¬2æ­¥ï¼šåˆ›å»ºå ä½æ–‡ä»¶
echo [2/6] ğŸ“ åˆ›å»ºå ä½æ–‡ä»¶...
type nul > logs\.gitkeep
type nul > uploads\.gitkeep
type nul > tests\.gitkeep
echo âœ… å ä½æ–‡ä»¶åˆ›å»ºå®Œæˆ
echo.

REM ç¬¬3æ­¥ï¼šæ£€æŸ¥Node.js
echo [3/6] ğŸ” æ£€æŸ¥å¼€å‘ç¯å¢ƒ...
where node >nul 2>nul
if %ERRORLEVEL% NEQ 0 (
    color 0C
    echo âŒ æœªå®‰è£… Node.js
    echo.
    echo è¯·è®¿é—® https://nodejs.org ä¸‹è½½å®‰è£…
    pause
    exit /b 1
)
for /f "tokens=*" %%i in ('node -v') do echo âœ… Node.js %%i
echo.

REM ç¬¬4æ­¥ï¼šå®‰è£…ä¾èµ–
echo [4/6] ğŸ“¦ å®‰è£…é¡¹ç›®ä¾èµ–...
if exist "package.json" (
    call npm install
    if %ERRORLEVEL% NEQ 0 (
        color 0C
        echo âŒ ä¾èµ–å®‰è£…å¤±è´¥
        pause
        exit /b 1
    )
    echo âœ… ä¾èµ–å®‰è£…æˆåŠŸ
) else (
    echo âš ï¸  æœªæ‰¾åˆ° package.jsonï¼Œè·³è¿‡
)
echo.

REM ç¬¬5æ­¥ï¼šé…ç½®ç¯å¢ƒå˜é‡
echo [5/6] âš™ï¸  é…ç½®ç¯å¢ƒå˜é‡...
if not exist ".env" (
    if exist ".env.example" (
        copy .env.example .env >nul
        echo âœ… .env æ–‡ä»¶å·²åˆ›å»º
        echo.
        set /p DB_PASS="è¯·è¾“å…¥ PostgreSQL å¯†ç : "
        powershell -Command "(Get-Content .env) -replace 'DB_PASSWORD=.*', 'DB_PASSWORD=%DB_PASS%' | Set-Content .env"
        echo âœ… æ•°æ®åº“å¯†ç å·²é…ç½®
    ) else (
        echo âš ï¸  æœªæ‰¾åˆ° .env.example
    )
) else (
    echo âœ… .env æ–‡ä»¶å·²å­˜åœ¨
)
echo.

REM ç¬¬6æ­¥ï¼šåˆ›å»ºæ•°æ®åº“
echo [6/6] ğŸ—„ï¸  åˆ›å»ºæ•°æ®åº“...
for /f "tokens=2 delims==" %%i in ('findstr "DB_PASSWORD" .env') do set DB_PASS=%%i
for /f "tokens=2 delims==" %%i in ('findstr "DB_NAME" .env') do set DB_NAME=%%i

set PGPASSWORD=%DB_PASS%
psql -U postgres -h localhost -c "CREATE DATABASE %DB_NAME%;" 2>nul

if %ERRORLEVEL% EQU 0 (
    echo âœ… æ•°æ®åº“ %DB_NAME% åˆ›å»ºæˆåŠŸ
) else (
    echo âš ï¸  æ•°æ®åº“å¯èƒ½å·²å­˜åœ¨
)
echo.

echo ========================================
echo âœ¨ è®¾ç½®å®Œæˆï¼
echo ========================================
echo.
echo ğŸ“‹ æ¥ä¸‹æ¥çš„æ­¥éª¤ï¼š
echo.
echo   1. å¤åˆ¶æ‰€æœ‰ä»£ç æ–‡ä»¶åˆ°å¯¹åº”ç›®å½•
echo   2. åŒå‡» start-dev.bat å¯åŠ¨æœåŠ¡å™¨
echo   3. åŒå‡» test-api.bat æµ‹è¯•æ¥å£
echo.
echo ğŸ’¡ æç¤ºï¼š
echo   - æ‰€æœ‰æ‰¹å¤„ç†æ–‡ä»¶éƒ½åœ¨é¡¹ç›®æ ¹ç›®å½•
echo   - åŒå‡»å³å¯è¿è¡Œï¼Œæ— éœ€å‘½ä»¤è¡Œ
echo.
pause


REM ==================== clean-project.bat ====================
REM æ¸…ç†é¡¹ç›® - åŒå‡»è¿è¡Œæ­¤æ–‡ä»¶
@echo off
chcp 65001 >nul

echo.
echo ========================================
echo ğŸ§¹ æ¸…ç†é¡¹ç›®
echo ========================================
echo.
echo å°†åˆ é™¤ï¼š
echo   - node_modulesï¼ˆä¾èµ–åŒ…ï¼‰
echo   - package-lock.jsonï¼ˆé”å®šæ–‡ä»¶ï¼‰
echo   - logs\*.logï¼ˆæ—¥å¿—æ–‡ä»¶ï¼‰
echo   - uploads\*ï¼ˆä¸Šä¼ çš„æ–‡ä»¶ï¼Œä¿ç•™.gitkeepï¼‰
echo.

set /p CONFIRM="ç¡®å®šè¦æ¸…ç†å—? (y/N): "

if /i "%CONFIRM%"=="y" (
    echo.
    echo æ­£åœ¨æ¸…ç†...
    
    if exist "node_modules" (
        echo åˆ é™¤ node_modules...
        rmdir /s /q node_modules
    )
    
    if exist "package-lock.json" (
        echo åˆ é™¤ package-lock.json...
        del /q package-lock.json
    )
    
    if exist "logs" (
        echo æ¸…ç†æ—¥å¿—æ–‡ä»¶...
        del /q logs\*.log 2>nul
    )
    
    if exist "uploads" (
        echo æ¸…ç†ä¸Šä¼ æ–‡ä»¶...
        for /d %%d in (uploads\*) do rmdir /s /q "%%d" 2>nul
        del /q uploads\*.* 2>nul
        type nul > uploads\.gitkeep
    )
    
    echo.
    echo âœ… æ¸…ç†å®Œæˆï¼
    echo.
    echo ä¸‹ä¸€æ­¥ï¼šè¿è¡Œ npm install é‡æ–°å®‰è£…ä¾èµ–
) else (
    echo æ“ä½œå·²å–æ¶ˆ
)
echo.
pause
