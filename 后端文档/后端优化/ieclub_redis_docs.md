# IEclub Redisç¼“å­˜å’Œä»»åŠ¡é˜Ÿåˆ—ç³»ç»Ÿ - å®Œæ•´æ–‡æ¡£

## ğŸ“‹ ç›®å½•

1. [ç³»ç»Ÿæ¦‚è¿°](#ç³»ç»Ÿæ¦‚è¿°)
2. [å®‰è£…é…ç½®](#å®‰è£…é…ç½®)
3. [åŠŸèƒ½ç‰¹æ€§](#åŠŸèƒ½ç‰¹æ€§)
4. [ä½¿ç”¨æŒ‡å—](#ä½¿ç”¨æŒ‡å—)
5. [ç›‘æ§ç®¡ç†](#ç›‘æ§ç®¡ç†)
6. [æ€§èƒ½ä¼˜åŒ–](#æ€§èƒ½ä¼˜åŒ–)
7. [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## ğŸ¯ ç³»ç»Ÿæ¦‚è¿°

### æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     åº”ç”¨å±‚ (Express)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç¼“å­˜ä¸­é—´ä»¶  â”‚  é˜Ÿåˆ—æœåŠ¡  â”‚  ç¼“å­˜æœåŠ¡  â”‚  æ§åˆ¶å™¨å±‚       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚              Redis Manager (è¿æ¥ç®¡ç†)                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ä¸»å®¢æˆ·ç«¯     â”‚  è®¢é˜…å®¢æˆ·ç«¯   â”‚  å‘å¸ƒå®¢æˆ·ç«¯   â”‚  é˜Ÿåˆ—å®¢æˆ·ç«¯ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Redis Server  â”‚
                    â”‚   (6379ç«¯å£)    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒç»„ä»¶

1. **RedisManager**: Redisè¿æ¥ç®¡ç†å™¨
   - æ”¯æŒä¸»ä»å¤åˆ¶
   - è‡ªåŠ¨é‡è¿æœºåˆ¶
   - è¿æ¥æ± ç®¡ç†
   - å‘å¸ƒè®¢é˜…æ”¯æŒ

2. **QueueManager**: ä»»åŠ¡é˜Ÿåˆ—ç®¡ç†å™¨
   - 5ä¸ªé¢„å®šä¹‰é˜Ÿåˆ—ï¼ˆé‚®ä»¶ã€å›¾ç‰‡ã€é€šçŸ¥ã€OCRã€ç»Ÿè®¡ï¼‰
   - å¤±è´¥é‡è¯•æœºåˆ¶
   - ä¼˜å…ˆçº§è°ƒåº¦
   - è¿›åº¦è·Ÿè¸ª

3. **CacheMiddleware**: ç¼“å­˜ä¸­é—´ä»¶
   - å“åº”ç¼“å­˜
   - è‡ªåŠ¨å¤±æ•ˆ
   - ç”¨æˆ·çº§ç¼“å­˜
   - åˆ†é¡µç¼“å­˜

4. **CacheService**: ç¼“å­˜æœåŠ¡
   - ç”¨æˆ·ç¼“å­˜
   - å¸–å­ç¼“å­˜
   - æœç´¢ç¼“å­˜
   - ä¼šè¯ç®¡ç†

---

## ğŸ”§ å®‰è£…é…ç½®

### 1. å®‰è£…RedisæœåŠ¡å™¨

#### Windows

```bash
# ä½¿ç”¨Chocolateyå®‰è£…
choco install redis-64

# æˆ–ä¸‹è½½MSIå®‰è£…åŒ…
# https://github.com/microsoftarchive/redis/releases

# å¯åŠ¨Redis
redis-server

# æµ‹è¯•è¿æ¥
redis-cli ping
# åº”è¯¥è¿”å›: PONG
```

#### macOS

```bash
# ä½¿ç”¨Homebrewå®‰è£…
brew install redis

# å¯åŠ¨Redis
brew services start redis

# æµ‹è¯•è¿æ¥
redis-cli ping
```

#### Linux (Ubuntu/Debian)

```bash
# å®‰è£…Redis
sudo apt update
sudo apt install redis-server

# å¯åŠ¨Redis
sudo systemctl start redis-server
sudo systemctl enable redis-server

# æµ‹è¯•è¿æ¥
redis-cli ping
```

### 2. å®‰è£…Node.jsä¾èµ–

```bash
cd ieclub-backend

# å®‰è£…Redisç›¸å…³åŒ…
npm install ioredis bull nodemailer

# æŸ¥çœ‹å·²å®‰è£…ç‰ˆæœ¬
npm list ioredis bull
```

### 3. é…ç½®ç¯å¢ƒå˜é‡

åœ¨ `.env` æ–‡ä»¶ä¸­æ·»åŠ ï¼š

```env
# Redisé…ç½®
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=
REDIS_DB=0

# é˜Ÿåˆ—é…ç½®
QUEUE_CONCURRENCY=5
QUEUE_REDIS_DB=1

# SMTPé‚®ä»¶é…ç½®ï¼ˆç”¨äºé‚®ä»¶é˜Ÿåˆ—ï¼‰
SMTP_HOST=smtp.example.com
SMTP_PORT=465
SMTP_USER=your-email@example.com
SMTP_PASS=your-password
SMTP_FROM="IEclub <noreply@ieclub.com>"

# å‰ç«¯URLï¼ˆç”¨äºé‚®ä»¶é“¾æ¥ï¼‰
FRONTEND_URL=http://localhost:3000
```

### 4. éªŒè¯å®‰è£…

åˆ›å»ºæµ‹è¯•è„šæœ¬ `test-redis.js`ï¼š

```javascript
const redis = require('./src/utils/redis');

async function test() {
  try {
    // åˆå§‹åŒ–Redis
    await redis.init();
    console.log('âœ… Redisåˆå§‹åŒ–æˆåŠŸ');

    // æµ‹è¯•PING
    const pong = await redis.ping();
    console.log('âœ… PINGæµ‹è¯•:', pong);

    // æµ‹è¯•SET/GET
    await redis.set('test:key', { message: 'Hello IEclub!' }, 60);
    const data = await redis.get('test:key');
    console.log('âœ… æ•°æ®æµ‹è¯•:', data);

    // æµ‹è¯•å®Œæˆ
    await redis.del('test:key');
    await redis.close();
    console.log('âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡!');
  } catch (error) {
    console.error('âŒ æµ‹è¯•å¤±è´¥:', error);
  }
}

test();
```

è¿è¡Œæµ‹è¯•ï¼š

```bash
node test-redis.js
```

---

## âœ¨ åŠŸèƒ½ç‰¹æ€§

### 1. ç¼“å­˜ç³»ç»Ÿ

#### å“åº”ç¼“å­˜

```javascript
// è‡ªåŠ¨ç¼“å­˜GETè¯·æ±‚å“åº”
router.get('/posts', 
  CacheMiddleware.cache({ ttl: 300 }), // ç¼“å­˜5åˆ†é’Ÿ
  PostController.getPosts
);
```

#### ç”¨æˆ·çº§ç¼“å­˜

```javascript
// æ ¹æ®ç”¨æˆ·IDç¼“å­˜
router.get('/my/posts',
  auth.required,
  CacheMiddleware.userCache(600), // ç¼“å­˜10åˆ†é’Ÿ
  PostController.getMyPosts
);
```

#### åˆ†é¡µç¼“å­˜

```javascript
// ç¼“å­˜åˆ†é¡µç»“æœ
router.get('/posts',
  CacheMiddleware.pageCache(180), // ç¼“å­˜3åˆ†é’Ÿ
  PostController.getPosts
);
```

#### è¯¦æƒ…ç¼“å­˜

```javascript
// ç¼“å­˜èµ„æºè¯¦æƒ…
router.get('/posts/:id',
  CacheMiddleware.detailCache('post', 600), // ç¼“å­˜10åˆ†é’Ÿ
  PostController.getPost
);
```

#### ç¼“å­˜å¤±æ•ˆ

```javascript
// æ›´æ–°æ—¶è‡ªåŠ¨æ¸…é™¤ç¼“å­˜
router.put('/posts/:id',
  auth.required,
  CacheMiddleware.invalidate([
    (req) => `cache:detail:post:${req.params.id}`,
    'cache:page:posts:*',
    'cache:list:posts:*'
  ]),
  PostController.updatePost
);
```

### 2. ä»»åŠ¡é˜Ÿåˆ—

#### é‚®ä»¶é˜Ÿåˆ—

```javascript
// å¼‚æ­¥å‘é€é‚®ä»¶
await QueueService.sendEmail(
  'user@example.com',
  'æ¬¢è¿åŠ å…¥IEclub',
  '<h1>æ¬¢è¿!</h1>',
  {
    priority: 3,  // é«˜ä¼˜å…ˆçº§
    delay: 0      // ç«‹å³å‘é€
  }
);

// æ‰¹é‡å‘é€
await QueueService.sendBulkEmails([
  { to: 'user1@example.com', subject: 'é€šçŸ¥1', html: '...' },
  { to: 'user2@example.com', subject: 'é€šçŸ¥2', html: '...' }
]);
```

#### å›¾ç‰‡å¤„ç†é˜Ÿåˆ—

```javascript
// å¼‚æ­¥å‹ç¼©å›¾ç‰‡
const job = await QueueService.processImage(
  '/uploads/image.jpg',
  {
    quality: 80,
    maxWidth: 1920,
    maxHeight: 1080
  }
);

// æŸ¥è¯¢å¤„ç†è¿›åº¦
const status = await QueueService.getJobStatus('image', job.id);
console.log(`å¤„ç†è¿›åº¦: ${status.progress}%`);
```

#### é€šçŸ¥é˜Ÿåˆ—

```javascript
// å‘é€å•ä¸ªé€šçŸ¥
await QueueService.sendNotification(
  userId,
  'like',
  {
    title: 'æ–°çš„ç‚¹èµ',
    content: 'æœ‰äººç‚¹èµäº†ä½ çš„å¸–å­'
  }
);

// æ‰¹é‡å‘é€é€šçŸ¥
await QueueService.sendBulkNotifications([
  { userId: 1, type: 'follow', title: 'æ–°å…³æ³¨', content: '...' },
  { userId: 2, type: 'comment', title: 'æ–°è¯„è®º', content: '...' }
]);
```

#### OCRè¯†åˆ«é˜Ÿåˆ—

```javascript
// å¼‚æ­¥è¯†åˆ«æ–‡å­—
const job = await QueueService.recognizeText(
  imagePath,
  userId,
  recordId
);

// æŸ¥è¯¢è¯†åˆ«ç»“æœ
const result = await QueueService.getJobStatus('ocr', job.id);
if (result.status === 'completed') {
  console.log('è¯†åˆ«æ–‡å­—:', result.result.text);
}
```

#### ç»Ÿè®¡ä»»åŠ¡é˜Ÿåˆ—

```javascript
// ç”Ÿæˆç»Ÿè®¡æ•°æ®
await QueueService.generateStats('users', 'daily');
await QueueService.generateStats('posts', 'weekly');
await QueueService.generateStats('events', 'monthly');
```

### 3. ç¼“å­˜æœåŠ¡API

#### ç”¨æˆ·ç¼“å­˜

```javascript
const CacheService = require('./services/cacheService');

// ç¼“å­˜ç”¨æˆ·ä¿¡æ¯
await CacheService.cacheUser(userId, userData, 3600);

// è·å–ç”¨æˆ·ä¿¡æ¯
const user = await CacheService.getCachedUser(userId);

// æ¸…é™¤ç”¨æˆ·ç¼“å­˜
await CacheService.clearUserCache(userId);
```

#### æµè§ˆè®¡æ•°

```javascript
// å¢åŠ æµè§ˆæ¬¡æ•°
const count = await CacheService.incrementViewCount('post', postId);

// è·å–æµè§ˆæ¬¡æ•°
const views = await CacheService.getViewCount('post', postId);
```

#### çƒ­é—¨å†…å®¹

```javascript
// ç¼“å­˜å¸–å­å¹¶æ›´æ–°çƒ­é—¨æ¦œ
await CacheService.cachePost(postId, postData);

// è·å–çƒ­é—¨å¸–å­
const hotPosts = await CacheService.getHotPosts(10);
```

#### æœç´¢ç¼“å­˜

```javascript
// ç¼“å­˜æœç´¢ç»“æœ
await CacheService.cacheSearchResults(query, results, 300);
```

#### ä¼šè¯ç®¡ç†

```javascript
// è®¾ç½®ä¼šè¯
await CacheService.setSession(sessionId, sessionData, 86400);

// è·å–ä¼šè¯
const session = await CacheService.getSession(sessionId);

// åˆ é™¤ä¼šè¯
await CacheService.deleteSession(sessionId);
```

---

## ğŸ“Š ç›‘æ§ç®¡ç†

### ç›‘æ§ç«¯ç‚¹

æ‰€æœ‰ç›‘æ§ç«¯ç‚¹éœ€è¦ç®¡ç†å‘˜æƒé™ï¼š

#### 1. RedisçŠ¶æ€

```bash
GET /api/metrics/redis

# å“åº”ç¤ºä¾‹
{
  "success": true,
  "data": {
    "connected": true,
    "usedMemory": "2.5M",
    "connectedClients": "3",
    "totalKeys": 1250,
    "hitRate": "87.5"
  }
}
```

#### 2. é˜Ÿåˆ—çŠ¶æ€

```bash
GET /api/metrics/queues

# å“åº”ç¤ºä¾‹
{
  "success": true,
  "data": {
    "email": {
      "name": "email",
      "waiting": 5,
      "active": 2,
      "completed": 1230,
      "failed": 15,
      "delayed": 0,
      "total": 1252
    },
    "image": { ... },
    "notification": { ... }
  }
}
```

#### 3. é˜Ÿåˆ—ç®¡ç†

```bash
# æš‚åœé˜Ÿåˆ—
POST /api/metrics/queues/email/pause

# æ¢å¤é˜Ÿåˆ—
POST /api/metrics/queues/email/resume

# æ¸…ç†å·²å®Œæˆä»»åŠ¡
POST /api/metrics/queues/email/clean

# é‡è¯•å¤±è´¥ä»»åŠ¡
POST /api/metrics/queues/email/retry

# æ¸…é™¤æ‰€æœ‰ç¼“å­˜
DELETE /api/metrics/cache
```

### å¥åº·æ£€æŸ¥

```bash
GET /api/health

# å“åº”ç¤ºä¾‹
{
  "status": "healthy",
  "timestamp": "2025-10-03T10:00:00.000Z",
  "services": {
    "redis": {
      "status": "up",
      "connected": true
    },
    "queues": {
      "email": { "status": "active", "jobs": 5 },
      "image": { "status": "active", "jobs": 2 }
    },
    "database": {
      "status": "up"
    }
  }
}
```

### ä½¿ç”¨Redis CLIç›‘æ§

```bash
# è¿æ¥åˆ°Redis
redis-cli

# æŸ¥çœ‹æ‰€æœ‰é”®
KEYS *

# æŸ¥çœ‹ç‰¹å®šæ¨¡å¼çš„é”®
KEYS cache:*
KEYS user:*
KEYS bull:*

# æŸ¥çœ‹é”®çš„å€¼
GET user:123
HGETALL session:abc123

# æŸ¥çœ‹é”®çš„è¿‡æœŸæ—¶é—´
TTL cache:post:456

# æŸ¥çœ‹å†…å­˜ä½¿ç”¨
INFO memory

# å®æ—¶ç›‘æ§å‘½ä»¤
MONITOR

# æŸ¥çœ‹æ…¢æ—¥å¿—
SLOWLOG GET 10

# æŸ¥çœ‹è¿æ¥çš„å®¢æˆ·ç«¯
CLIENT LIST

# æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯
INFO stats
```

---

## âš¡ æ€§èƒ½ä¼˜åŒ–

### 1. ç¼“å­˜ç­–ç•¥

#### ç¼“å­˜æ—¶é—´è®¾ç½®

```javascript
// ä¸åŒç±»å‹æ•°æ®çš„æ¨èTTL
const cacheTTL = {
  // é™æ€å†…å®¹ - é•¿æ—¶é—´ç¼“å­˜
  staticContent: 86400,      // 24å°æ—¶
  userProfile: 3600,         // 1å°æ—¶
  
  // åŠ¨æ€å†…å®¹ - ä¸­ç­‰æ—¶é—´ç¼“å­˜
  postList: 300,             // 5åˆ†é’Ÿ
  postDetail: 600,           // 10åˆ†é’Ÿ
  searchResults: 180,        // 3åˆ†é’Ÿ
  
  // å®æ—¶å†…å®¹ - çŸ­æ—¶é—´ç¼“å­˜
  hotPosts: 60,              // 1åˆ†é’Ÿ
  notification: 30,          // 30ç§’
  
  // ä¼šè¯æ•°æ®
  session: 86400,            // 24å°æ—¶
  verificationCode: 600      // 10åˆ†é’Ÿ
};
```

#### ç¼“å­˜é¢„çƒ­

```javascript
// å¯åŠ¨æ—¶é¢„çƒ­çƒ­é—¨æ•°æ®
async function warmUpCache() {
  const { Post, User, Event } = require('./models');
  
  // ç¼“å­˜çƒ­é—¨å¸–å­
  const hotPosts = await Post.findAll({
    where: { viewCount: { [Op.gt]: 1000 } },
    limit: 50
  });
  
  for (const post of hotPosts) {
    await CacheService.cachePost(post.id, post.toJSON());
  }
  
  // ç¼“å­˜æ´»è·ƒç”¨æˆ·
  const activeUsers = await User.findAll({
    where: { status: 'active' },
    order: [['lastLoginAt', 'DESC']],
    limit: 100
  });
  
  for (const user of activeUsers) {
    await CacheService.cacheUser(user.id, user.toJSON());
  }
  
  logger.info('ç¼“å­˜é¢„çƒ­å®Œæˆ');
}
```

### 2. é˜Ÿåˆ—ä¼˜åŒ–

#### å¹¶å‘æ§åˆ¶

```javascript
// è®¾ç½®é˜Ÿåˆ—å¹¶å‘æ•°
const imageQueue = queueManager.createQueue('image', {
  limiter: {
    max: 50,           // æ¯åˆ†é’Ÿæœ€å¤š50ä¸ªä»»åŠ¡
    duration: 60000
  },
  settings: {
    maxStalledCount: 3,    // æœ€å¤§åœæ»æ¬¡æ•°
    stalledInterval: 30000  // æ£€æŸ¥é—´éš”
  }
});

// è®¾ç½®å¤„ç†å™¨å¹¶å‘
imageQueue.process(5, async (job) => {
  // æœ€å¤š5ä¸ªä»»åŠ¡å¹¶å‘å¤„ç†
  return await processImage(job.data);
});
```

#### ä¼˜å…ˆçº§é˜Ÿåˆ—

```javascript
// æ ¹æ®ä¸šåŠ¡é‡è¦æ€§è®¾ç½®ä¼˜å…ˆçº§
const priorities = {
  critical: 10,   // ç´§æ€¥ä»»åŠ¡ï¼ˆæ”¯ä»˜ã€å®‰å…¨ï¼‰
  high: 5,        // é«˜ä¼˜å…ˆçº§ï¼ˆéªŒè¯é‚®ä»¶ï¼‰
  normal: 1,      // æ™®é€šä»»åŠ¡ï¼ˆé€šçŸ¥ï¼‰
  low: 0          // ä½ä¼˜å…ˆçº§ï¼ˆç»Ÿè®¡ï¼‰
};

// æ·»åŠ ä»»åŠ¡æ—¶æŒ‡å®šä¼˜å…ˆçº§
await emailQueue.add(data, {
  priority: priorities.high
});
```

### 3. Redisé…ç½®ä¼˜åŒ–

#### redis.conf ä¼˜åŒ–å»ºè®®

```conf
# å†…å­˜ç®¡ç†
maxmemory 2gb
maxmemory-policy allkeys-lru

# æŒä¹…åŒ–ï¼ˆæ ¹æ®éœ€æ±‚é€‰æ‹©ï¼‰
save 900 1      # 900ç§’å†…è‡³å°‘1ä¸ªé”®æ”¹å˜
save 300 10     # 300ç§’å†…è‡³å°‘10ä¸ªé”®æ”¹å˜
save 60 10000   # 60ç§’å†…è‡³å°‘10000ä¸ªé”®æ”¹å˜

# AOFæŒä¹…åŒ–ï¼ˆæ›´å®‰å…¨ä½†ç¨æ…¢ï¼‰
appendonly yes
appendfsync everysec

# ç½‘ç»œä¼˜åŒ–
tcp-backlog 511
timeout 300
tcp-keepalive 300

# æ…¢æŸ¥è¯¢æ—¥å¿—
slowlog-log-slower-than 10000
slowlog-max-len 128
```

### 4. ç›‘æ§æŒ‡æ ‡

```javascript
// å®šæœŸæ”¶é›†æ€§èƒ½æŒ‡æ ‡
setInterval(async () => {
  const stats = await CacheService.getCacheStats();
  
  logger.info('Redisæ€§èƒ½æŒ‡æ ‡', {
    hitRate: stats.hitRate,
    usedMemory: stats.usedMemory,
    connectedClients: stats.connectedClients,
    totalKeys: stats.totalKeys
  });
  
  // å‘Šè­¦ï¼šå‘½ä¸­ç‡ä½äº80%
  if (parseFloat(stats.hitRate) < 80) {
    logger.warn('ç¼“å­˜å‘½ä¸­ç‡è¿‡ä½ï¼', { hitRate: stats.hitRate });
  }
  
  // å‘Šè­¦ï¼šè¿æ¥æ•°è¿‡å¤š
  if (parseInt(stats.connectedClients) > 100) {
    logger.warn('Redisè¿æ¥æ•°è¿‡å¤šï¼', { clients: stats.connectedClients });
  }
}, 60000); // æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
```

---

## ğŸ“ ä½¿ç”¨æŒ‡å—

### åœºæ™¯1ï¼šç”¨æˆ·æ³¨å†Œæµç¨‹

```javascript
// æ§åˆ¶å™¨
class AuthController {
  static async register(req, res) {
    try {
      const { email, password, nickname } = req.body;
      
      // 1. åˆ›å»ºç”¨æˆ·
      const user = await User.create({
        email,
        password: await bcrypt.hash(password, 10),
        nickname,
        status: 'pending'
      });
      
      // 2. ç”ŸæˆéªŒè¯token
      const token = jwt.sign(
        { userId: user.id, type: 'email_verify' },
        process.env.JWT_SECRET,
        { expiresIn: '24h' }
      );
      
      // 3. ç¼“å­˜tokenï¼ˆé˜²æ­¢é‡å¤å‘é€ï¼‰
      const cacheKey = `verify:${user.id}`;
      await redis.set(cacheKey, token, 86400);
      
      // 4. å¼‚æ­¥å‘é€éªŒè¯é‚®ä»¶
      await QueueService.sendEmail(
        email,
        'IEclub - é‚®ç®±éªŒè¯',
        emailTemplate.verification(user, token),
        { priority: 3 }
      );
      
      res.status(201).json({
        success: true,
        message: 'æ³¨å†ŒæˆåŠŸï¼Œè¯·æŸ¥æ”¶éªŒè¯é‚®ä»¶',
        data: { userId: user.id }
      });
    } catch (error) {
      res.status(500).json({ success: false, error: error.message });
    }
  }
}
```

### åœºæ™¯2ï¼šå¸–å­å‘å¸ƒæµç¨‹

```javascript
class PostController {
  static async createPost(req, res) {
    try {
      const { title, content, images, tags } = req.body;
      const userId = req.user.id;
      
      // 1. åˆ›å»ºå¸–å­
      const post = await Post.create({
        title,
        content,
        authorId: userId,
        status: 'published'
      });
      
      // 2. å¤„ç†å›¾ç‰‡ï¼ˆå¼‚æ­¥ï¼‰
      if (images && images.length > 0) {
        const imageJobs = images.map(img => ({
          data: {
            imagePath: img.path,
            options: { quality: 80, maxWidth: 1920 }
          }
        }));
        await imageQueue.addBulk(imageJobs);
      }
      
      // 3. æ¸…é™¤ç›¸å…³ç¼“å­˜
      await redis.delPattern('cache:page:posts:*');
      await redis.delPattern('cache:list:posts:*');
      
      // 4. é€šçŸ¥å…³æ³¨è€…ï¼ˆå¼‚æ­¥ï¼‰
      const followers = await user.getFollowers();
      const notifications = followers.map(f => ({
        userId: f.id,
        type: 'new_post',
        title: 'æ–°å¸–å­',
        content: `${user.nickname}å‘å¸ƒäº†æ–°å¸–å­: ${title}`
      }));
      await QueueService.sendBulkNotifications(notifications);
      
      // 5. æ›´æ–°ç”¨æˆ·ç»Ÿè®¡ï¼ˆå¼‚æ­¥ï¼‰
      await User.increment('postCount', { where: { id: userId } });
      
      res.status(201).json({
        success: true,
        data: post
      });
    } catch (error) {
      res.status(500).json({ success: false, error: error.message });
    }
  }
}
```

### åœºæ™¯3ï¼šæ´»åŠ¨æŠ¥åæµç¨‹

```javascript
class EventController {
  static async registerEvent(req, res) {
    try {
      const { eventId } = req.params;
      const userId = req.user.id;
      
      // 1. ä½¿ç”¨Rediså®ç°åˆ†å¸ƒå¼é”ï¼ˆé˜²æ­¢è¶…é¢æŠ¥åï¼‰
      const lockKey = `lock:event:${eventId}`;
      const lockValue = Date.now().toString();
      
      // å°è¯•è·å–é”ï¼ˆ10ç§’è¶…æ—¶ï¼‰
      const locked = await redis.getClient().set(
        lockKey,
        lockValue,
        'NX',
        'EX',
        10
      );
      
      if (!locked) {
        return res.status(409).json({
          success: false,
          error: 'æŠ¥åäººæ•°è¿‡å¤šï¼Œè¯·ç¨åé‡è¯•'
        });
      }
      
      try {
        // 2. æ£€æŸ¥æ´»åŠ¨
        const event = await Event.findByPk(eventId);
        if (!event) {
          return res.status(404).json({
            success: false,
            error: 'æ´»åŠ¨ä¸å­˜åœ¨'
          });
        }
        
        // 3. æ£€æŸ¥äººæ•°é™åˆ¶
        const currentCount = await EventRegistration.count({
          where: { eventId, status: 'confirmed' }
        });
        
        if (currentCount >= event.maxParticipants) {
          return res.status(400).json({
            success: false,
            error: 'æ´»åŠ¨å·²æ»¡å‘˜'
          });
        }
        
        // 4. åˆ›å»ºæŠ¥åè®°å½•
        const registration = await EventRegistration.create({
          eventId,
          userId,
          status: 'confirmed'
        });
        
        // 5. å‘é€ç¡®è®¤é‚®ä»¶ï¼ˆå¼‚æ­¥ï¼‰
        await QueueService.sendEmail(
          req.user.email,
          `æ´»åŠ¨æŠ¥åç¡®è®¤ - ${event.title}`,
          emailTemplate.eventConfirmation(req.user, event),
          { priority: 2 }
        );
        
        // 6. æ¸…é™¤æ´»åŠ¨ç¼“å­˜
        await redis.del(`cache:detail:event:${eventId}`);
        
        res.json({
          success: true,
          data: registration
        });
        
      } finally {
        // 7. é‡Šæ”¾é”
        const currentLock = await redis.get(lockKey);
        if (currentLock === lockValue) {
          await redis.del(lockKey);
        }
      }
      
    } catch (error) {
      res.status(500).json({ success: false, error: error.message });
    }
  }
}
```

### åœºæ™¯4ï¼šOCRè¯†åˆ«æµç¨‹

```javascript
class OCRController {
  static async uploadAndRecognize(req, res) {
    try {
      const userId = req.user.id;
      const file = req.file;
      
      // 1. éªŒè¯æ–‡ä»¶
      if (!file) {
        return res.status(400).json({
          success: false,
          error: 'è¯·ä¸Šä¼ å›¾ç‰‡'
        });
      }
      
      // 2. æ£€æŸ¥é¢‘ç‡é™åˆ¶ï¼ˆæ¯å°æ—¶æœ€å¤š10æ¬¡ï¼‰
      const rateLimitKey = `ocr:rate:${userId}`;
      const count = await redis.incr(rateLimitKey);
      
      if (count === 1) {
        await redis.expire(rateLimitKey, 3600);
      }
      
      if (count > 10) {
        return res.status(429).json({
          success: false,
          error: 'è¯†åˆ«æ¬¡æ•°å·²è¾¾ä¸Šé™ï¼Œè¯·1å°æ—¶åå†è¯•'
        });
      }
      
      // 3. åˆ›å»ºè®°å½•
      const record = await OCRRecord.create({
        userId,
        imagePath: file.path,
        status: 'processing'
      });
      
      // 4. æ·»åŠ åˆ°é˜Ÿåˆ—
      const job = await QueueService.recognizeText(
        file.path,
        userId,
        record.id
      );
      
      res.status(202).json({
        success: true,
        message: 'å›¾ç‰‡ä¸Šä¼ æˆåŠŸï¼Œæ­£åœ¨è¯†åˆ«ä¸­...',
        data: {
          recordId: record.id,
          jobId: job.id,
          estimatedTime: '30-60ç§’'
        }
      });
      
    } catch (error) {
      res.status(500).json({ success: false, error: error.message });
    }
  }
  
  // è½®è¯¢æŸ¥è¯¢ç»“æœ
  static async getRecognitionResult(req, res) {
    try {
      const { id } = req.params;
      const userId = req.user.id;
      
      const record = await OCRRecord.findOne({
        where: { id, userId }
      });
      
      if (!record) {
        return res.status(404).json({
          success: false,
          error: 'è®°å½•ä¸å­˜åœ¨'
        });
      }
      
      res.json({
        success: true,
        data: {
          id: record.id,
          status: record.status,
          result: record.result,
          confidence: record.confidence
        }
      });
      
    } catch (error) {
      res.status(500).json({ success: false, error: error.message });
    }
  }
}
```

---

## ğŸ› å¸¸è§é—®é¢˜

### 1. Redisè¿æ¥å¤±è´¥

**é—®é¢˜**: `Error: connect ECONNREFUSED 127.0.0.1:6379`

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ£€æŸ¥Redisæ˜¯å¦è¿è¡Œ
redis-cli ping

# å¦‚æœæ²¡è¿è¡Œï¼Œå¯åŠ¨Redis
# Windows
redis-server

# Linux/macOS
redis-server /etc/redis/redis.conf
```

### 2. é˜Ÿåˆ—ä»»åŠ¡åœæ»

**é—®é¢˜**: ä»»åŠ¡ä¸€ç›´å¤„äºwaitingçŠ¶æ€ä¸æ‰§è¡Œ

**è§£å†³æ–¹æ¡ˆ**:
```javascript
// æ£€æŸ¥æ˜¯å¦æ³¨å†Œäº†å¤„ç†å™¨
emailQueue.process(async (job) => {
  // å¤„ç†é€»è¾‘
});

// æˆ–è€…æ‰‹åŠ¨è§¦å‘å¤„ç†
const queue = queueManager.getQueue('email');
await queue.resume();
```

### 3. ç¼“å­˜å‘½ä¸­ç‡ä½

**é—®é¢˜**: ç¼“å­˜å‘½ä¸­ç‡ä½äº50%

**è§£å†³æ–¹æ¡ˆ**:
```javascript
// 1. å¢åŠ ç¼“å­˜æ—¶é—´
CacheMiddleware.cache({ ttl: 600 }) // ä»300æ”¹ä¸º600

// 2. ä½¿ç”¨æ›´ç²¾ç¡®çš„ç¼“å­˜é”®
keyGenerator: (req) => {
  const { page, limit } = req.query;
  return `cache:posts:${page}:${limit}`; // ä¸åŒ…å«éšæœºå‚æ•°
}

// 3. é¢„çƒ­çƒ­é—¨æ•°æ®
await warmUpCache();
```

### 4. å†…å­˜ä½¿ç”¨è¿‡é«˜

**é—®é¢˜**: Rediså†…å­˜å ç”¨è¿‡é«˜

**è§£å†³æ–¹æ¡ˆ**:
```bash
# 1. æŸ¥çœ‹å†…å­˜ä½¿ç”¨
redis-cli INFO memory

# 2. æ¸…ç†è¿‡æœŸé”®
redis-cli --scan --pattern "cache:*" | xargs redis-cli DEL

# 3. é…ç½®å†…å­˜æ·˜æ±°ç­–ç•¥
# åœ¨redis.confä¸­æ·»åŠ 
maxmemory 2gb
maxmemory-policy allkeys-lru
```

### 5. é˜Ÿåˆ—ä»»åŠ¡å¤±è´¥è¿‡å¤š

**é—®é¢˜**: ä»»åŠ¡å¤±è´¥ç‡è¶…è¿‡10%

**è§£å†³æ–¹æ¡ˆ**:
```javascript
// 1. å¢åŠ é‡è¯•æ¬¡æ•°
await emailQueue.add(data, {
  attempts: 5,  // ä»3æ”¹ä¸º5
  backoff: {
    type: 'exponential',
    delay: 3000  // å¢åŠ å»¶è¿Ÿ
  }
});

// 2. æ·»åŠ è¶…æ—¶è®¾ç½®
await ocrQueue.add(data, {
  timeout: 120000  // 2åˆ†é’Ÿè¶…æ—¶
});

// 3. æ‰‹åŠ¨é‡è¯•å¤±è´¥ä»»åŠ¡
await queueManager.retryFailed('email');
```

---

## ğŸ“ˆ æ€§èƒ½åŸºå‡†

### é¢„æœŸæ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | ä¼˜ç§€å€¼ |
|------|--------|--------|
| ç¼“å­˜å‘½ä¸­ç‡ | >80% | >90% |
| Rediså“åº”æ—¶é—´ | <10ms | <5ms |
| é˜Ÿåˆ—å¤„ç†é€Ÿåº¦ | >100ä»»åŠ¡/åˆ† | >500ä»»åŠ¡/åˆ† |
| å†…å­˜ä½¿ç”¨ | <2GB | <1GB |
| å¹¶å‘è¿æ¥æ•° | <50 | <20 |

### å‹åŠ›æµ‹è¯•

```bash
# ä½¿ç”¨redis-benchmarkæµ‹è¯•
redis-benchmark -h localhost -p 6379 -c 50 -n 100000

# æµ‹è¯•SETæ€§èƒ½
redis-benchmark -t set -n 100000 -q

# æµ‹è¯•GETæ€§èƒ½
redis-benchmark -t get -n 100000 -q

# æµ‹è¯•å®Œæ•´æµç¨‹
redis-benchmark -t set,get,lpush,lpop -n 100000 -q
```

---

## ğŸš€ æœ€ä½³å®è·µ

### 1. é”®å‘½åè§„èŒƒ

```javascript
// ä½¿ç”¨å†’å·åˆ†éš”çš„å±‚çº§ç»“æ„
cache:page:posts:1:20
cache:detail:post:123
user:profile:456
session:abc123
lock:event:789
queue:email:job:1001
```

### 2. é”™è¯¯å¤„ç†

```javascript
// ç¼“å­˜æ“ä½œå¤±è´¥ä¸åº”å½±å“ä¸»æµç¨‹
try {
  await redis.set(key, value, ttl);
} catch (error) {
  logger.error('ç¼“å­˜è®¾ç½®å¤±è´¥:', error);
  // ç»§ç»­æ‰§è¡Œï¼Œä¸ä¸­æ–­ä¸»æµç¨‹
}
```

### 3. ç›‘æ§å‘Šè­¦

```javascript
// è®¾ç½®æ€§èƒ½ç›‘æ§
const monitor = {
  checkHealth: async () => {
    const stats = await CacheService.getCacheStats();
    
    if (parseFloat(stats.hitRate) < 70) {
      // å‘é€å‘Šè­¦
      await alertService.send('Rediså‘½ä¸­ç‡è¿‡ä½', stats);
    }
  }
};

// æ¯5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
setInterval(monitor.checkHealth, 300000);
```

### 4. æ•°æ®ä¸€è‡´æ€§

```javascript
// æ›´æ–°æ•°æ®åº“æ—¶åŒæ­¥æ¸…é™¤ç¼“å­˜
async function updatePost(postId, data) {
  const transaction = await sequelize.transaction();
  
  try {
    // æ›´æ–°æ•°æ®åº“
    await Post.update(data, {
      where: { id: postId },
      transaction
    });
    
    // æäº¤äº‹åŠ¡
    await transaction.commit();
    
    // æ¸…é™¤ç¼“å­˜
    await redis.del(`cache:detail:post:${postId}`);
    await redis.delPattern(`cache:page:posts:*`);
    
  } catch (error) {
    await transaction.rollback();
    throw error;
  }
}
```

---

## ğŸ“š å‚è€ƒèµ„æº

- [ioredis æ–‡æ¡£](https://github.com/redis/ioredis)
- [Bull é˜Ÿåˆ—æ–‡æ¡£](https://github.com/OptimalBits/bull)
- [Redis å®˜æ–¹æ–‡æ¡£](https://redis.io/documentation)
- [ç¼“å­˜æœ€ä½³å®è·µ](https://redis.io/topics/lru-cache)

---

## ğŸ‰ æ€»ç»“

ä½ ç°åœ¨æ‹¥æœ‰äº†ä¸€ä¸ª**å•†ä¸šçº§çš„Redisç¼“å­˜å’Œä»»åŠ¡é˜Ÿåˆ—ç³»ç»Ÿ**ï¼ŒåŒ…æ‹¬ï¼š

âœ… **å®Œæ•´çš„ä»£ç å®ç°**
- RedisManager (è¿æ¥ç®¡ç†)
- QueueManager (é˜Ÿåˆ—ç®¡ç†)  
- CacheMiddleware (ç¼“å­˜ä¸­é—´ä»¶)
- CacheService (ç¼“å­˜æœåŠ¡)
- QueueService (é˜Ÿåˆ—æœåŠ¡)

âœ… **5ä¸ªé¢„å®šä¹‰é˜Ÿåˆ—**
- é‚®ä»¶é˜Ÿåˆ—
- å›¾ç‰‡å¤„ç†é˜Ÿåˆ—
- é€šçŸ¥é˜Ÿåˆ—
- OCRè¯†åˆ«é˜Ÿåˆ—
- ç»Ÿè®¡ä»»åŠ¡é˜Ÿåˆ—

âœ… **ç›‘æ§å’Œç®¡ç†**
- å®Œæ•´çš„ç›‘æ§ç«¯ç‚¹
- å¥åº·æ£€æŸ¥ç³»ç»Ÿ
- æ€§èƒ½ç»Ÿè®¡åˆ†æ

âœ… **ç”Ÿäº§å°±ç»ª**
- è‡ªåŠ¨é‡è¿æœºåˆ¶
- å¤±è´¥é‡è¯•ç­–ç•¥
- ä¼˜é›…å…³é—­å¤„ç†
- è¯¦ç»†æ—¥å¿—è®°å½•

**ç«‹å³å¼€å§‹ä½¿ç”¨**:
```bash
npm install ioredis bull nodemailer
node test-redis.js
npm run dev
```